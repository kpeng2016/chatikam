<!DOCTYPE html>
<html>
<head>
    <title>CHAT.IK.AM</title>

    <!--<link href="vendor/uikit/dist/css/uikit.min.css" rel="stylesheet">-->
    <link href="style.css" rel="stylesheet">
</head>
<body>
<noscript><h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being
    enabled. Please enable
    Javascript and reload this page!</h2></noscript>
<div ng-app="" ng-controller="ChatController">
    <div>
        <input ng-model="ctrl.nickname" ng-disabled="ctrl.connected" type="text" id="nickname" placeholder="nickname"
               required=""/>
        <input ng-model="ctrl.channel" ng-disabled="ctrl.connected" type="text" id="channel" placeholder="channel"
               required=""/>
        <button id="connect" ng-click="connect()" ng-disabled="ctrl.connected">Connect</button>
        <button id="disconnect" ng-disabled="!ctrl.connected" ng-click="disconnect()">Disconnect</button>
        <label><input type="checkbox" ng-model="ctrl.notify"/>Notify</label>
    </div>
    <div id="chat-panel">
        <table id="chat-table">
            <tr>
                <td id="recipient">
                    <ul>
                        <li ng-repeat="(nickname, v) in nicknames">{{nickname}}</li>
                    </ul>
                </td>
                <td id="chat">
                    <div id="#chat-windows">
                        <div class="chat-window">
                            <p ng-repeat='message in messages'><strong>{{message.nickname.value}}</strong> &gt; <span>{{message.message}}</span>
                            </p>
                        </div>
                    </div>
                </td>
            </tr>
            <tr id="conversationDiv">
                <td id="input-cell" colspan="2">
                    <label>Message: </label><input ng-model="text" ng-disabled="!ctrl.connected" type="text"
                                                   id="message" size="80"/>
                    <button id="sendName" ng-click="sendMessage()" ng-disabled="!ctrl.connected">Send</button>
                </td>
            </tr>
        </table>
    </div>
</div>
<script src="vendor/angular/angular.min.js"></script>
<script src="vendor/sockjs/sockjs.js"></script>
<script src="vendor/stomp-websocket/lib/stomp.js"></script>
<script type="text/javascript">
    var Notification = window.Notification || window.mozNotification || window.webkitNotification;
    if (Notification) {
        Notification.requestPermission(function (permission) {
        });
    }
    function ChatController($scope) {
        $scope.ctrl = {
            connected: false,
            nickname: '',
            channel: '',
            notify: false
        };
        $scope.nicknames = {};
        $scope.messages = [];
        $scope.text = '';
        $scope.stompClient = null;
        $scope.connect = function () {
            var nickname = $scope.ctrl.nickname;
            var channel = $scope.ctrl.channel;

            if (!(nickname && channel)) {
                alert('enter nickname and channel!');
                return;
            }

            var socket = new SockJS('/chat');
            $scope.stompClient = Stomp.over(socket);
            $scope.stompClient.connect({}, function (frame) {
                $scope.ctrl.connected = true;
                $scope.stompClient.subscribe('/topic/message/' + encodeURIComponent(channel),
                        function (res) {
                            var message = JSON.parse(res.body);
                            $scope.messages.push(message);
                            if ($scope.ctrl.notify && Notification) {
                                var from = message.nickname.value;
                                if (from != nickname) {
                                    var title = from + ' @ ' + message.channelName.value;
                                    new Notification(title, {body: message.message});
                                }
                            }
                            $scope.$apply();
                        });
                $scope.stompClient.subscribe('/app/join/' + encodeURIComponent(channel) + '/' + encodeURIComponent(nickname),
                        function (participants) {
                            JSON.parse(participants.body).forEach(function (partiticant) {
                                $scope.nicknames[partiticant.value] = true;
                            });
                            $scope.$apply();
                        });
                $scope.stompClient.subscribe('/topic/join/' + encodeURIComponent(channel), function (nickname) {
                    $scope.nicknames[JSON.parse(nickname.body).value] = true;
                    $scope.$apply();
                });
                $scope.stompClient.subscribe('/topic/leave/' + encodeURIComponent(channel), function (nickname) {
                    delete $scope.nicknames[JSON.parse(nickname.body).value];
                    $scope.$apply();
                });
                $scope.$apply();
            });
        };

        $scope.disconnect = function () {
            $scope.stompClient.disconnect();
            $scope.ctrl.connected = false;
            $scope.messages = [];
            $scope.nicknames = {};
            $scope.stompClient = null;
        };

        $scope.sendMessage = function () {
            var message = $scope.text;
            var channel = $scope.ctrl.channel;
            $scope.stompClient.send("/app/message/" + encodeURIComponent(channel), {},
                    JSON.stringify({ 'message': encodeURIComponent(message) }));
            $scope.text = '';
        }

        $scope.debug = function () {
            console.log($scope);
        }
    }
</script>
</body>
</html>